-- BOARD_TYPE 테이블 생성
CREATE TABLE BOARD_TYPE (
   BOARD_TYPE_NO NUMBER PRIMARY KEY,
   BOARD_TYPE_NAME VARCHAR2(100) NOT NULL
);

-- TAG 테이블 생성
CREATE TABLE TAG (
   TAG_NAME VARCHAR2(50) PRIMARY KEY,
   TAG_IMG VARCHAR2(100) NOT NULL
);

-- ITEM 테이블 생성
CREATE TABLE ITEM (
   ITEM_NO NUMBER PRIMARY KEY,
   ITEM_NAME VARCHAR2(100) NOT NULL,
   ITEM_PRICE NUMBER NOT NULL,
   ITEM_DELETE_DATE DATE NULL
);

-- USER_TB 테이블 생성
CREATE TABLE USER_TB (
   USER_NO NUMBER PRIMARY KEY,
   USER_ID VARCHAR2(100) NOT NULL,
   USER_PWD VARCHAR2(100) NOT NULL,
   USER_NAME VARCHAR2(100) NOT NULL,
   USER_NICKNAME VARCHAR2(100) NOT NULL UNIQUE,
   PHONE VARCHAR2(50) NOT NULL,
   EMAIL VARCHAR2(100) NOT NULL,
   USER_CREATE_DATE DATE DEFAULT SYSDATE NOT NULL,
   USER_DELETE_DATE DATE NULL,
   IS_SOCIAL VARCHAR2(50) NOT NULL,
   ROLE VARCHAR2(50) NOT NULL,
   USER_POINT NUMBER DEFAULT 1000 NOT NULL,
   ITEM_NO NUMBER NULL,
   PHOTO_NO NUMBER NULL,
   FOREIGN KEY (ITEM_NO) REFERENCES ITEM(ITEM_NO)
);

-- FILE_TB 테이블 생성
CREATE TABLE FILE_TB (
   ATTACH_NO NUMBER PRIMARY KEY,
   USER_NO NUMBER NOT NULL,
   UUID VARCHAR2(200) NOT NULL UNIQUE,
   FILE_URL VARCHAR2(300) NOT NULL,
   REAL_PATH VARCHAR2(300) NOT NULL,
   MIME_TYPE VARCHAR2(50) NOT NULL,
   UPLOAD_TIME DATE DEFAULT SYSDATE NOT NULL,
   ORIGINAL_FILE_NAME VARCHAR2(100) NOT NULL,
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- VIDEO 테이블 생성
CREATE TABLE VIDEO (
   VIDEO_NO NUMBER PRIMARY KEY,
   ATTACH_NO NUMBER NOT NULL,
   FOREIGN KEY (ATTACH_NO) REFERENCES FILE_TB(ATTACH_NO)
);

-- BOARD 테이블 생성
CREATE TABLE BOARD (
   BOARD_NO NUMBER PRIMARY KEY,
   USER_NO NUMBER NOT NULL,
   BOARD_TYPE_NO NUMBER NOT NULL,
   VIDEO_NO NUMBER NULL,
   BOARD_CONTENT VARCHAR2(3000) NOT NULL,
   BOARD_TITLE VARCHAR2(100) NOT NULL,
   BOARD_COUNT NUMBER DEFAULT 0 NOT NULL,
   BOARD_LIKE NUMBER DEFAULT 0 NOT NULL,
   BOARD_CREATE_DATE DATE DEFAULT SYSDATE NOT NULL,
   BOARD_DELETE_DATE DATE DEFAULT NULL NULL,
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO),
   FOREIGN KEY (BOARD_TYPE_NO) REFERENCES BOARD_TYPE(BOARD_TYPE_NO),
   FOREIGN KEY (VIDEO_NO) REFERENCES VIDEO(VIDEO_NO)
);

-- PHOTO 테이블 생성
CREATE TABLE PHOTO (
   PHOTO_NO NUMBER PRIMARY KEY,
   ATTACH_NO NUMBER NOT NULL,
   BOARD_NO NUMBER ,
   PHOTO_ORDER NUMBER DEFAULT 1 NOT NULL,
   FOREIGN KEY (ATTACH_NO) REFERENCES FILE_TB(ATTACH_NO),
   FOREIGN KEY (BOARD_NO) REFERENCES BOARD(BOARD_NO)
);

-- USER_TB의 PROFILE_ATTACH 외래키 추가
ALTER TABLE USER_TB ADD FOREIGN KEY (PHOTO_NO) REFERENCES PHOTO(PHOTO_NO);

-- USER_BLOCK 테이블 생성
CREATE TABLE USER_BLOCK (
   BLOCKER_NO NUMBER NOT NULL,
   BLOCKED_NO NUMBER NOT NULL,
   CONSTRAINT PK_USER_BLOCK PRIMARY KEY (BLOCKER_NO, BLOCKED_NO),
   CONSTRAINT BLOCKER_NO FOREIGN KEY (BLOCKER_NO) REFERENCES USER_TB(USER_NO),
   CONSTRAINT BLOCKED_NO FOREIGN KEY (BLOCKED_NO) REFERENCES USER_TB(USER_NO)
);

-- USER_PREFERENCE 테이블 생성
CREATE TABLE USER_PREFERENCE (
   USER_NO NUMBER NOT NULL,
   TAG_NAME VARCHAR2(50) NOT NULL,
   TAG_COUNT NUMBER DEFAULT 0 NOT NULL,
   CONSTRAINT PK_USER_PREFERENCE PRIMARY KEY (USER_NO, TAG_NAME),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO),
   FOREIGN KEY (TAG_NAME) REFERENCES TAG(TAG_NAME)
);

-- POINT_HISTORY 테이블 생성
CREATE TABLE POINT_HISTORY (
   POINT_HISTORY_NO NUMBER PRIMARY KEY,
   USER_NO NUMBER NOT NULL,
   POINT_DATE DATE DEFAULT SYSDATE NOT NULL,
   POINT_AMOUNT NUMBER NOT NULL,
   POINT_SOURCE VARCHAR2(100) NOT NULL,
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);


-- ITEM_IMG 테이블 생성
CREATE TABLE ITEM_IMG (
   ITEM_NO NUMBER NOT NULL,
   ATTACH_NO NUMBER NOT NULL,
   CONSTRAINT PK_ITEM_IMG PRIMARY KEY (ITEM_NO, ATTACH_NO),
   FOREIGN KEY (ITEM_NO) REFERENCES ITEM(ITEM_NO),
   FOREIGN KEY (ATTACH_NO) REFERENCES FILE_TB(ATTACH_NO)
);


-- USER_ITEM 테이블 생성
CREATE TABLE USER_ITEM (
   USER_NO NUMBER NOT NULL,
   ITEM_NO NUMBER NOT NULL,
   CONSTRAINT PK_USER_ITEM PRIMARY KEY (USER_NO, ITEM_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO),
   FOREIGN KEY (ITEM_NO) REFERENCES ITEM(ITEM_NO)
);

-- MESSAGE 테이블 생성
CREATE TABLE MESSAGE (
   MESSAGE_NO NUMBER PRIMARY KEY,
   SEND_USER_NO NUMBER NOT NULL,
   RECEIVE_USER_NO NUMBER NOT NULL,
   MESSAGE_CONTENT VARCHAR2(3000) NOT NULL,
   MESSAGE_DATE DATE DEFAULT SYSDATE NOT NULL,
   MESSAGE_DELETE_DATE DATE NULL,
   CONSTRAINT SEND_USER_NO FOREIGN KEY (SEND_USER_NO) REFERENCES USER_TB(USER_NO),
   CONSTRAINT RECEIVE_USER_NO FOREIGN KEY (RECEIVE_USER_NO) REFERENCES USER_TB(USER_NO)
);

-- BOARD_LIKE 테이블 생성
CREATE TABLE BOARD_LIKE (
   USER_NO NUMBER NOT NULL,
   BOARD_NO NUMBER NOT NULL,
   CONSTRAINT PK_BOARD_LIKE PRIMARY KEY (USER_NO, BOARD_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO),
   FOREIGN KEY (BOARD_NO) REFERENCES BOARD(BOARD_NO)
);

-- GUESS_THE_RANK 테이블 생성
CREATE TABLE GUESS_THE_RANK (
   GTR_NO NUMBER PRIMARY KEY,
   VIDEO_NO NUMBER NOT NULL,
   TIER VARCHAR2(50) NOT NULL,
   FOREIGN KEY (VIDEO_NO) REFERENCES VIDEO(VIDEO_NO)
);

-- COMMENT_TB 테이블 생성
CREATE TABLE COMMENT_TB (
   COMMENT_NO NUMBER PRIMARY KEY,
   BOARD_NO NUMBER NOT NULL,
   USER_NO NUMBER NOT NULL,
   PARENT_COMMENT_NO NUMBER NULL,
   COMMENT_CONTENT VARCHAR2(3000) NOT NULL,
   COMMENT_CREATE_DATE DATE DEFAULT SYSDATE NOT NULL,
   COMMENT_DELETE_DATE DATE NULL,
   FOREIGN KEY (BOARD_NO) REFERENCES BOARD(BOARD_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- REPORT 테이블 생성
CREATE TABLE REPORT (
   REPORT_NO NUMBER PRIMARY KEY,
   USER_NO NUMBER NOT NULL,
   BOARD_NO NUMBER ,
   COMMENT_NO NUMBER,
   REPORT_CONTENT VARCHAR2(3000) NULL,
   REPORT_TYPE VARCHAR2(50) NOT NULL,
   REPORT_DATE DATE DEFAULT SYSDATE NOT NULL,
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO),
   FOREIGN KEY (BOARD_NO) REFERENCES BOARD(BOARD_NO),
   FOREIGN KEY (COMMENT_NO) REFERENCES COMMENT_TB(COMMENT_NO)
);


-- COMMENT_TB의 PARENT_COMMENT_NO 외래키는 테이블 생성 후에 추가 (자기참조)
ALTER TABLE COMMENT_TB ADD FOREIGN KEY (PARENT_COMMENT_NO) REFERENCES COMMENT_TB(COMMENT_NO);

-- TAG_BY_VIDEO 테이블 생성
CREATE TABLE TAG_BY_VIDEO (
   VIDEO_NO NUMBER NOT NULL,
   TAG_NAME VARCHAR2(50) NOT NULL,
   CONSTRAINT PK_TAG_BY_VIDEO PRIMARY KEY (VIDEO_NO, TAG_NAME),
   FOREIGN KEY (VIDEO_NO) REFERENCES VIDEO(VIDEO_NO),
   FOREIGN KEY (TAG_NAME) REFERENCES TAG(TAG_NAME)
);


-- MADMOVIE_WORLD_CUP_RESULT 테이블 생성
CREATE TABLE MADMOVIE_WORLD_CUP_RESULT (
   WORLD_CUP_NO NUMBER PRIMARY KEY,
   VIDEO_NO NUMBER NOT NULL,
   USER_NO NUMBER NOT NULL,
   WIN_DATE DATE DEFAULT SYSDATE NOT NULL,
   FOREIGN KEY (VIDEO_NO) REFERENCES VIDEO(VIDEO_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- COMMENT_LIKE 테이블 생성
CREATE TABLE COMMENT_LIKE (
   COMMENT_NO NUMBER NOT NULL,
   USER_NO NUMBER NOT NULL,
   CONSTRAINT PK_COMMENT_LIKE PRIMARY KEY (COMMENT_NO, USER_NO),
   FOREIGN KEY (COMMENT_NO) REFERENCES COMMENT_TB(COMMENT_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- GUESS_THE_RANK_HISTORY 테이블 생성
CREATE TABLE GUESS_THE_RANK_HISTORY (
   GTR_HISTORY_NO NUMBER PRIMARY KEY,
   GTR_NO NUMBER NOT NULL,
   USER_NO NUMBER NOT NULL,
   IS_CORRECT CHAR(1) NOT NULL,
   SOLVE_DATE DATE DEFAULT SYSDATE NOT NULL,
   FOREIGN KEY (GTR_NO) REFERENCES GUESS_THE_RANK(GTR_NO),
   FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- FOLLOW 테이블 생성
CREATE TABLE FOLLOW (
   FOLLOWER_NO NUMBER NOT NULL,
   USER_NO NUMBER NOT NULL,
   CONSTRAINT PK_FOLLOW PRIMARY KEY (FOLLOWER_NO, USER_NO),
   CONSTRAINT FOLLOWER_NO FOREIGN KEY (FOLLOWER_NO) REFERENCES USER_TB(USER_NO),
   CONSTRAINT FOLLOW_USER_NO FOREIGN KEY (USER_NO) REFERENCES USER_TB(USER_NO)
);

-- 1. 외래키 참조만 하는 테이블들 (다른 테이블에서 참조되지 않음)
DROP TABLE FOLLOW CASCADE CONSTRAINTS;
DROP TABLE GUESS_THE_RANK_HISTORY CASCADE CONSTRAINTS;
DROP TABLE COMMENT_LIKE CASCADE CONSTRAINTS;
DROP TABLE MADMOVIE_WORLD_CUP_RESULT CASCADE CONSTRAINTS;
DROP TABLE TAG_BY_VIDEO CASCADE CONSTRAINTS;
DROP TABLE REPORT CASCADE CONSTRAINTS;
DROP TABLE BOARD_LIKE CASCADE CONSTRAINTS;
DROP TABLE USER_PREFERENCE CASCADE CONSTRAINTS;
DROP TABLE USER_BLOCK CASCADE CONSTRAINTS;
DROP TABLE USER_ITEM CASCADE CONSTRAINTS;
DROP TABLE ITEM_IMG CASCADE CONSTRAINTS;
DROP TABLE POINT_HISTORY CASCADE CONSTRAINTS;
DROP TABLE MESSAGE CASCADE CONSTRAINTS;

-- 2. 다른 테이블들
DROP TABLE COMMENT_TB CASCADE CONSTRAINTS;
DROP TABLE GUESS_THE_RANK CASCADE CONSTRAINTS;
DROP TABLE PHOTO CASCADE CONSTRAINTS;
DROP TABLE BOARD CASCADE CONSTRAINTS;
DROP TABLE VIDEO CASCADE CONSTRAINTS;
DROP TABLE FILE_TB CASCADE CONSTRAINTS;
DROP TABLE USER_TB CASCADE CONSTRAINTS;
DROP TABLE ITEM CASCADE CONSTRAINTS;
DROP TABLE TAG CASCADE CONSTRAINTS;
DROP TABLE BOARD_TYPE CASCADE CONSTRAINTS;


--시퀀스 생성
CREATE SEQUENCE SEQ_COMMENT_NO;
CREATE SEQUENCE SEQ_GTR_HISTORY_NO;
CREATE SEQUENCE SEQ_GTR_NO;
CREATE SEQUENCE SEQ_VIDEO_NO;
CREATE SEQUENCE SEQ_BOARD_NO;
CREATE SEQUENCE SEQ_ATTACH_NO;
CREATE SEQUENCE SEQ_WORLD_CUP_NO;
CREATE SEQUENCE SEQ_MESSAGE_NO;
CREATE SEQUENCE SEQ_USER_NO;
CREATE SEQUENCE SEQ_REPORT_NO;
CREATE SEQUENCE SEQ_PHOTO_NO;
CREATE SEQUENCE SEQ_BOARD_TYPE_NO;
CREATE SEQUENCE SEQ_POINT_HISTORY_NO;
CREATE SEQUENCE SEQ_ITEM_NO;

--시퀀스 삭제
DROP SEQUENCE SEQ_COMMENT_NO;
DROP SEQUENCE SEQ_GTR_HISTORY_NO;
DROP SEQUENCE SEQ_GTR_NO;
DROP SEQUENCE SEQ_VIDEO_NO;
DROP SEQUENCE SEQ_BOARD_NO;
DROP SEQUENCE SEQ_ATTACH_NO;
DROP SEQUENCE SEQ_WORLD_CUP_NO;
DROP SEQUENCE SEQ_MESSAGE_NO;
DROP SEQUENCE SEQ_USER_NO;
DROP SEQUENCE SEQ_REPORT_NO;
DROP SEQUENCE SEQ_PHOTO_NO;
DROP SEQUENCE SEQ_BOARD_TYPE_NO;
DROP SEQUENCE SEQ_POINT_HISTORY_NO;
DROP SEQUENCE SEQ_ITEM_NO;